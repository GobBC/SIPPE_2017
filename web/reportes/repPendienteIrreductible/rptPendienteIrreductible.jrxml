<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="rptPendienteIrreductible" language="groovy" pageWidth="592" pageHeight="752" whenNoDataType="NoDataSection" columnWidth="572" leftMargin="10" rightMargin="10" topMargin="10" bottomMargin="10" uuid="756d8746-89ef-46b1-9d19-1b6d452e7c89">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="155"/>
	<property name="ireport.y" value="0"/>
	<parameter name="YEAR" class="java.lang.String"/>
	<parameter name="USUARIO" class="java.lang.String"/>
	<queryString>
		<![CDATA[select r.ramo||'-'||r.descr as ramo,
       ar.partida as partida,
       sum(nvl(r.techo_presup,0)) as techo,
       sum(nvl(ar.importe_accion,0)) as importe_capturado,
       max(nvl(ar.importe_irreductible,0)) as impte_irreductible,
       ( sum(nvl(r.techo_presup,0)) - sum(nvl(ar.importe_accion,0))) as importe_pendiente_captura,

       case
       when (sum(nvl(ar.importe_irreductible,0)) - sum(nvl(ar.importe_accion,0)) )<0
       then 0
       else
       ( sum(nvl(ar.importe_irreductible,0)) - sum(nvl(ar.importe_accion,0)) )
       end
       as importe_pendiente_irreductible,

       (
       (sum(nvl(ar.importe_accion,0))
       ) /(
       case
       when  abs(max(nvl(ar.importe_irreductible,1)))=0 then 1
       else
       abs(max(nvl(ar.importe_irreductible,1)))
       end

       )




       ) as porcentaje_irreductible
from (
select
 m.ramo as ramo,
 m.partida as partida,
 m.year as year,
 sum(sar.costo_anual) as importe_accion,
 max(nvl(m.IMPTE_IRREDUCTIBLE,0)) as importe_irreductible
 from S_POA_ACCION_REQ sar,
      poa.partida_minimo m
 where m.year=$P{YEAR} and
       m.ramo in(select DISTINCT ur.ramo
                        from POA.VW_ACC_USR_RAMO ur
                        where ur.app_login=$P{USUARIO} and
                              ur.year=$P{YEAR}) and
       sar.ramo(+)=m.ramo and
       sar.year(+)=m.year and
       sar.partida(+)=m.partida
      group by m.ramo,m.partida,m.year
      order by m.ramo,m.partida) ar,
      dgi.ramos r


where r.ramo=ar.ramo(+) and
      r.year=ar.year(+) and
      ar.importe_irreductible>0 and
      r.year=$P{YEAR} and
		r.ramo in(select DISTINCT ur.ramo
						from POA.VW_ACC_USR_RAMO ur
						where ur.app_login=$P{USUARIO} and
								ur.year=$P{YEAR}
					  )

group by r.ramo||'-'||r.descr,ar.partida
order by r.ramo||'-'||r.descr,ar.partida]]>
	</queryString>
	<field name="RAMO" class="java.lang.String"/>
	<field name="PARTIDA" class="java.lang.String"/>
	<field name="TECHO" class="java.math.BigDecimal"/>
	<field name="IMPORTE_CAPTURADO" class="java.math.BigDecimal"/>
	<field name="IMPTE_IRREDUCTIBLE" class="java.math.BigDecimal"/>
	<field name="IMPORTE_PENDIENTE_CAPTURA" class="java.math.BigDecimal"/>
	<field name="IMPORTE_PENDIENTE_IRREDUCTIBLE" class="java.math.BigDecimal"/>
	<field name="PORCENTAJE_IRREDUCTIBLE" class="java.math.BigDecimal"/>
	<variable name="TECHO_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{TECHO}]]></variableExpression>
	</variable>
	<variable name="IMPORTE_CAPTURADO_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{IMPORTE_CAPTURADO}]]></variableExpression>
	</variable>
	<variable name="IMPORTE_PENDIENTE_CAPTURA_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{IMPORTE_PENDIENTE_CAPTURA}]]></variableExpression>
	</variable>
	<variable name="TECHO_2" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{TECHO}]]></variableExpression>
	</variable>
	<variable name="IMPORTE_CAPTURADO_2" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{IMPORTE_CAPTURADO}]]></variableExpression>
	</variable>
	<variable name="IMPORTE_PENDIENTE_IRREDUCTIBLE_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{IMPORTE_PENDIENTE_IRREDUCTIBLE}]]></variableExpression>
	</variable>
	<variable name="PORCENTAJE_IRREDUCTIBLE_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{PORCENTAJE_IRREDUCTIBLE}]]></variableExpression>
	</variable>
	<variable name="IMPTE_IRREDUCTIBLE_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{IMPTE_IRREDUCTIBLE}]]></variableExpression>
	</variable>
	<background>
		<band splitType="Stretch"/>
	</background>
	<pageHeader>
		<band height="23">
			<staticText>
				<reportElement uuid="88a1854d-ac9b-4f45-9f51-0dbb16c7d899" mode="Opaque" x="0" y="2" width="572" height="20" forecolor="#FFFFFF" backcolor="#02A3DF"/>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Información Pendiente con Importe Irreductible]]></text>
			</staticText>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="20" splitType="Stretch">
			<staticText>
				<reportElement uuid="80bd2663-a562-4ff1-8ffd-a59c3133cc0e" mode="Opaque" x="0" y="0" width="163" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8"/>
				</textElement>
				<text><![CDATA[Ramo]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="8c67f9c4-a02d-4f31-b9ab-e378bfe28794" mode="Opaque" x="198" y="0" width="96" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8"/>
				</textElement>
				<text><![CDATA[Importe Calculado]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="574253d6-6c4f-4367-b4b1-8a25dbd6d2c5" mode="Opaque" x="390" y="0" width="96" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8"/>
				</textElement>
				<text><![CDATA[Pendiente Irreductible]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="82f828a7-6931-471b-9698-3360ee719b51" mode="Opaque" x="486" y="0" width="86" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8"/>
				</textElement>
				<text><![CDATA[% Irreductible]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="a4d25f84-2099-4285-acdf-bdb108a2186c" mode="Opaque" x="163" y="0" width="35" height="20" backcolor="#CCCCCC"/>
				<box>
					<pen lineWidth="0.5" lineColor="#000000"/>
					<topPen lineWidth="0.5" lineColor="#000000"/>
					<leftPen lineWidth="0.5" lineColor="#000000"/>
					<bottomPen lineWidth="0.5" lineColor="#000000"/>
					<rightPen lineWidth="0.5" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<text><![CDATA[Partida]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="47c98b25-2d1f-45f7-9f3f-2c1b27d7a7b1" mode="Opaque" x="294" y="0" width="96" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8"/>
				</textElement>
				<text><![CDATA[Importe Irreductible]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<textField isStretchWithOverflow="true">
				<reportElement uuid="819eb01a-4347-4116-bbbb-34d2c60076c4" stretchType="RelativeToBandHeight" x="0" y="0" width="163" height="20"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="8"/>
					<paragraph leftIndent="5"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{RAMO}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="¤ #,##0.00">
				<reportElement uuid="2179e1f4-3053-4af2-b814-2936bc579071" stretchType="RelativeToBandHeight" x="198" y="0" width="96" height="20"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
					<paragraph rightIndent="5"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{IMPORTE_CAPTURADO}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="¤ #,##0.00">
				<reportElement uuid="3a0616b0-886d-4e23-846e-eb2b8c652e12" stretchType="RelativeToBandHeight" x="390" y="0" width="96" height="20"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
					<paragraph rightIndent="5"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{IMPORTE_PENDIENTE_IRREDUCTIBLE}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00 %" isBlankWhenNull="true">
				<reportElement uuid="dd356822-9e07-46f8-85a3-54996838bed7" x="486" y="0" width="86" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{PORCENTAJE_IRREDUCTIBLE}>1?1:$F{PORCENTAJE_IRREDUCTIBLE}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement uuid="1e95b568-5a83-4b66-ad9f-31a59dafa9db" x="163" y="0" width="35" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{PARTIDA}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="¤ #,##0.00" isBlankWhenNull="true">
				<reportElement uuid="fe332cb6-b671-4c82-8404-828881bf4569" x="294" y="0" width="96" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{IMPTE_IRREDUCTIBLE}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="22">
			<staticText>
				<reportElement uuid="d88819ae-8a49-4386-a176-1fc977ffb742" x="0" y="0" width="142" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<text><![CDATA[<rptPendientesImporteIrreductible>]]></text>
			</staticText>
			<textField pattern="dd/MM/yyyy">
				<reportElement uuid="3ad7f142-dd35-49d4-87d5-a102cd63827c" x="260" y="0" width="100" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement uuid="5bd6c65a-0759-4090-8128-161d7b8229c5" x="451" y="0" width="80" height="20"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA["Page "+$V{PAGE_NUMBER}+" of"]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement uuid="ae3fde79-7287-4b64-8b0c-224555a4bf29" x="531" y="0" width="40" height="20"/>
				<textElement verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="23" splitType="Stretch">
			<staticText>
				<reportElement uuid="418e5dbb-251a-48cf-b2e6-b89256a6b6a1" mode="Opaque" x="0" y="0" width="198" height="20" backcolor="#CCCCCC"/>
				<box>
					<topPen lineWidth="0.5" lineColor="#666666"/>
					<leftPen lineWidth="0.5" lineColor="#666666"/>
					<bottomPen lineWidth="0.5" lineColor="#666666"/>
					<rightPen lineWidth="0.5" lineColor="#666666"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[TOTAL:]]></text>
			</staticText>
			<textField isStretchWithOverflow="true" pattern="¤ #,##0.00" isBlankWhenNull="true">
				<reportElement uuid="fc37dbfd-b339-4152-8e0a-b20eea8081b0" x="198" y="0" width="96" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{IMPORTE_CAPTURADO_2}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="¤ #,##0.00" isBlankWhenNull="true">
				<reportElement uuid="c4507c13-fbe9-4c38-af29-f04263261bbd" x="390" y="0" width="96" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{IMPORTE_PENDIENTE_IRREDUCTIBLE_1}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="#,##0.00 %" isBlankWhenNull="true">
				<reportElement uuid="6a766159-babf-472f-8d91-9dc04808d8ea" x="486" y="0" width="86" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[($V{IMPORTE_PENDIENTE_IRREDUCTIBLE_1}/$V{IMPTE_IRREDUCTIBLE_1}).abs()]]></textFieldExpression>
			</textField>
			<textField pattern="¤ #,##0.00">
				<reportElement uuid="54c02665-da26-404c-a458-638ddefdee24" x="294" y="0" width="96" height="20"/>
				<box>
					<pen lineWidth="0.5"/>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{IMPTE_IRREDUCTIBLE_1}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
	<noData>
		<band height="32">
			<staticText>
				<reportElement uuid="80b2ce50-1569-4580-9990-8d8d9dd23669" mode="Opaque" x="0" y="5" width="572" height="20" forecolor="#FFFFFF" backcolor="#02A3DF"/>
				<textElement textAlignment="Center" verticalAlignment="Middle" markup="none">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Información Pendiente con Importe Irreductible]]></text>
			</staticText>
		</band>
	</noData>
</jasperReport>
